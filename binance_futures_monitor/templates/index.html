<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance åˆçº¦ç›‘æ§çœ‹æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: 600; }
        .log-box { height: 400px; overflow-y: scroll; background-color: #1e1e1e; color: #d4d4d4; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; border-radius: 4px; }
        .alert-card { border-left: 5px solid #dc3545; transition: transform 0.2s; }
        .alert-card:hover { transform: translateY(-2px); }
        .score-badge { font-size: 1.2rem; font-weight: bold; }
        .status-badge { font-size: 0.8rem; margin-right: 5px; }
        .refresh-spin { animation: spin 1s linear infinite; }
        /* æ‚¬åœæŠ¥è­¦å¡ç‰‡æ ·å¼ */
        .sticky-alert {
            position: sticky;
            top: 10px;
            z-index: 1000;
            border-left: 5px solid #ffc107 !important; /* æ©™è‰²è¾¹æ¡†åŒºåˆ† */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">ğŸš€ Binance Futures Monitor v2.1 (Breakout & Surge)</span>
            <span class="text-light" id="last-update">ç­‰å¾…æ›´æ–°...</span>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§ï¼šå®æ—¶é«˜åˆ†æŠ¥è­¦ -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸš¨ é«˜åˆ†æŠ¥è­¦ä¿¡å· (Live Alerts)</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="testDiscord(this)">ğŸ§ª æµ‹è¯•æ¨é€</button>
                            <button class="btn btn-sm btn-outline-danger me-2" onclick="clearAlerts()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
                            <span class="badge bg-danger" id="alert-count">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container">
                            <div class="text-center text-muted p-5">æš‚æ— æŠ¥è­¦ä¿¡å·</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç³»ç»Ÿæ—¥å¿— + å›æµ‹ç»“æœ -->
            <div class="col-md-5">
                <!-- å›æµ‹ç»“æœå¡ç‰‡ -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <span>ğŸ§ª ä¿¡å·å›æµ‹ç»“æœ (30m Backtest)</span>
                        <span class="badge bg-light text-dark" id="backtest-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-box" id="backtest-container" style="height: 250px; background-color: #f0f8ff; color: #333;">
                            <div class="text-center text-muted p-5">æš‚æ— å›æµ‹æ•°æ® (éœ€ç­‰å¾…30åˆ†é’Ÿ)</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        ğŸ“ ç³»ç»Ÿè¿è¡Œæ—¥å¿— (System Logs)
                    </div>
                    <div class="card-body p-0">
                        <div class="log-box" id="log-container">
                            <!-- æ—¥å¿—å†…å®¹å°†é€šè¿‡ JS æ’å…¥ -->
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        â„¹ï¸ ç›‘æ§çŠ¶æ€
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ç›‘æ§å¸ç§æ•°é‡
                                <span class="badge bg-primary rounded-pill">Top 200</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Kçº¿å‘¨æœŸ
                                <span class="badge bg-secondary rounded-pill">15m</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                æŠ¥è­¦é˜ˆå€¼
                                <span class="badge bg-warning text-dark rounded-pill">Score > 75</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    // æ›´æ–°æ—¶é—´
                    const now = new Date();
                    document.getElementById('last-update').innerText = 'æœ€åæ›´æ–°: ' + now.toLocaleTimeString();

                    // 1. æ›´æ–°æ—¥å¿—
                    const logContainer = document.getElementById('log-container');
                    if (data.logs && data.logs.length > 0) {
                        logContainer.innerHTML = data.logs.map(line => `<div>${line}</div>`).join('');
                        logContainer.scrollTop = logContainer.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    }

                    // 3. æ›´æ–°å›æµ‹
                    const backtestContainer = document.getElementById('backtest-container');
                    const backtestCount = document.getElementById('backtest-count');
                    
                    if (data.backtests && data.backtests.length > 0) {
                        backtestCount.innerText = data.backtests.length;
                        // å€’åº
                        const btHtml = data.backtests.reverse().map(bt => {
                            let content = bt.content
                                .replace(/\n/g, '<br>')
                                .replace(/æœŸé—´æœ€é«˜æ¶¨å¹…: ([+\-]\d+\.\d+%)/, 'æœŸé—´æœ€é«˜æ¶¨å¹…: <span class="text-success fw-bold">$1</span>')
                                .replace(/æœŸé—´æœ€å¤§å›æ’¤: ([+\-]\d+\.\d+%)/, 'æœŸé—´æœ€å¤§å›æ’¤: <span class="text-danger fw-bold">$1</span>');
                                
                            return `
                                <div class="border-bottom p-2 mb-1">
                                    <small class="text-muted">${bt.time}</small>
                                    <div style="font-size: 0.85rem;">${content}</div>
                                </div>
                            `;
                        }).join('');
                        backtestContainer.innerHTML = btHtml;
                    } else {
                        backtestCount.innerText = 0;
                        backtestContainer.innerHTML = '<div class="text-center text-muted p-5">æš‚æ— å›æµ‹æ•°æ® (éœ€ç­‰å¾…30åˆ†é’Ÿ)</div>';
                    }

                    // 4. æ›´æ–°æŠ¥è­¦
                    const alertsContainer = document.getElementById('alerts-container');
                    const alertCount = document.getElementById('alert-count');
                    
                    if (data.alerts && data.alerts.length > 0) {
                        alertCount.innerText = data.alerts.length;
                        
                        let html = '';
                        // å€’åºå±•ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
                        
                        // ç»Ÿè®¡ä¿¡æ¯ç°åœ¨ç›´æ¥ä»åç«¯è·å– (data.stats)
                        const stats = data.stats || {};

                        data.alerts.reverse().forEach(alert => {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡å‡†äº¤æ˜“æŠ¥è­¦
                            const isTradeAlert = alert.content.includes("ã€é«˜åˆ†æŠ¥è­¦ã€‘");
                            
                            if (!isTradeAlert) {
                                // å¤„ç†ç³»ç»Ÿè­¦å‘Š/é”™è¯¯ (å¦‚ BTC æ€¥è·Œ, API é”™è¯¯)
                                let alertClass = "alert-warning";
                                let icon = "âš ï¸";
                                if (alert.content.includes("ERROR") || alert.content.includes("å¤±è´¥")) {
                                    alertClass = "alert-danger";
                                    icon = "âŒ";
                                }
                                
                                // æ¸…ç†æ—¥å¿—å‰ç¼€
                                let cleanContent = alert.content;
                                if (cleanContent.includes(" - ")) {
                                    cleanContent = cleanContent.split(" - ")[1];
                                }
                                
                                html += `
                                    <div class="alert ${alertClass} mb-3 shadow-sm">
                                        <div class="d-flex justify-content-between">
                                            <strong>${icon} ç³»ç»Ÿæ¶ˆæ¯</strong>
                                            <small>${alert.time}</small>
                                        </div>
                                        <div class="mt-1">${cleanContent}</div>
                                    </div>
                                `;
                                return; // è·³è¿‡åç»­å¤„ç†
                            }

                            // ç®€å•çš„è§£æé€»è¾‘
                            
                            // 1. æå–å¸ç§åç§°
                            let symbol = "UNKNOWN";
                            const symbolMatch = alert.content.match(/ã€é«˜åˆ†æŠ¥è­¦ã€‘\s+([A-Z0-9\/:]+)/);
                            if (symbolMatch) symbol = symbolMatch[1];
                            
                            // ä¸´æ—¶ä¿®å¤ï¼šå¤„ç† UNKNOWN çš„é—®é¢˜
                            if (symbol === "UNKNOWN") {
                                const retryMatch = alert.content.match(/ã€é«˜åˆ†æŠ¥è­¦ã€‘\s+(.+?)\s+\|/);
                                if (retryMatch) symbol = retryMatch[1];
                            }
                            
                            // 2. æå–è¯„åˆ†
                            let score = 0;
                            const scoreMatch = alert.content.match(/Score:\s+(\d+)/);
                            if (scoreMatch) score = parseInt(scoreMatch[1]);
                            
                            // 3. æå–ä»·æ ¼
                            let price = "N/A";
                            const priceMatch = alert.content.match(/ä»·æ ¼:\s+([\d.]+)/);
                            if (priceMatch) price = priceMatch[1];

                            // 4. åˆ¤æ–­æ–¹å‘ (æ ¹æ®å»ºè®®å†…å®¹)
                            let directionBadge = '<span class="badge bg-secondary">è§‚å¯Ÿ</span>';
                            const isFundingNegative = alert.content.includes("èµ„é‡‘è´¹ç‡: -");
                            
                            // OBV è¶‹åŠ¿æ£€æŸ¥ (å†…å®¹ä¸­æ˜¯å¦åŒ…å« "OBVè¶‹åŠ¿ç¡®è®¤")
                            const isObvTrend = alert.content.includes("OBVè¶‹åŠ¿ç¡®è®¤");
                            
                            if (isFundingNegative) {
                                directionBadge = '<span class="badge bg-success">æ½œåœ¨åšå¤š (è´¹ç‡<0)</span>';
                            } else {
                                directionBadge = '<span class="badge bg-warning text-dark">åŒå‘å…³æ³¨</span>';
                            }
                            
                            // å¦‚æœæ»¡è¶³ OBV è¶‹åŠ¿ï¼Œè¦†ç›–æˆ–è¿½åŠ é«˜äº®æ ·å¼
                            // æˆ‘ä»¬å¯ä»¥ç»™æ•´ä¸ªå¡ç‰‡åŠ ä¸€ä¸ªç‰¹æ®Šçš„è¾¹æ¡†é¢œè‰²ï¼Œæˆ–è€…åœ¨æ–¹å‘å¾½ç« æ—åŠ ä¸€ä¸ª OBV å¾½ç« 
                            let obvBadge = "";
                            if (isObvTrend) {
                                obvBadge = '<span class="badge bg-warning text-dark ms-1">âš¡ OBVç¡®è®¤</span>';
                                // ä¹Ÿå¯ä»¥è®©å¡ç‰‡èƒŒæ™¯å¾®å¾®æ³›é»„æ¥é«˜äº®
                            }

                            // 5. æ£€æŸ¥å‡ºç°æ¬¡æ•° & é¦–è½®æ—¶é—´ (ä½¿ç”¨åç«¯ç»Ÿè®¡çš„å…¨å±€æ•°æ®)
                            const symbolStat = stats[symbol] || {count: 0, first_time: "N/A"};
                            const count = symbolStat.count;
                            const firstTime = symbolStat.first_time;
                            
                            // ç®€åŒ–æ—¶é—´æ˜¾ç¤ºï¼Œåªå–æ—¶åˆ†ç§’ (å‡è®¾æ ¼å¼ YYYY-MM-DD HH:MM:SS...)
                            const shortFirstTime = firstTime.split(' ').length > 1 ? firstTime.split(' ')[1].split('.')[0] : firstTime;
                            
                            let countBadge = `<span class="badge bg-light text-dark border" title="é¦–è½®æŠ¥è­¦: ${firstTime}">å‡ºç° ${count} æ¬¡ <small class="text-muted">(${shortFirstTime}èµ·)</small></span>`;
                            let stickyClass = "";
                            
                            if (count > 15) {
                                countBadge = `<span class="badge bg-danger" title="é¦–è½®æŠ¥è­¦: ${firstTime}">ğŸ”¥ é¢‘ç¹æŠ¥è­¦ (${count}æ¬¡, ${shortFirstTime}èµ·)</span>`;
                                stickyClass = "sticky-alert"; // è§¦å‘æ‚¬åœæ ·å¼
                            }
                            
                            // OBV é«˜äº®æ ·å¼å¢å¼ºï¼šå¦‚æœæ»¡è¶³ OBVï¼Œç»™å¡ç‰‡åŠ ä¸€ä¸ªç‰¹æ®Šçš„é»„è‰²è¾¹æ¡†æ ·å¼ (å¦‚æœä¸ä¸ sticky å†²çª)
                            // æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°çš„ class
                            if (isObvTrend) {
                                stickyClass += " border-warning"; // Bootstrap border color
                                // æˆ–è€…è‡ªå®šä¹‰æ ·å¼
                            }

                            // 6. æ ¼å¼åŒ–å†…å®¹ (ä¿ç•™åŸæœ‰æ ¼å¼åŒ–ï¼Œä½†ç²¾ç®€å¤´éƒ¨)
                            // å»æ‰ç¬¬ä¸€è¡Œ "ğŸš¨ ã€é«˜åˆ†æŠ¥è­¦ã€‘..." å› ä¸ºæˆ‘ä»¬å·²ç»åœ¨æ ‡é¢˜æ å±•ç¤ºäº†
                            let contentBody = alert.content.split('\n').slice(1).join('\n');
                            
                            let formattedContent = contentBody
                                .replace(/\n/g, '<br>')
                                .replace(/çŠ¶æ€: (.*)/, '<strong>çŠ¶æ€:</strong> $1')
                                .replace(/\[åšå¤šå»ºè®®\]/g, '<span class="badge bg-success">åšå¤šå»ºè®®</span>')
                                .replace(/\[åšç©ºå»ºè®®\]/g, '<span class="badge bg-danger">åšç©ºå»ºè®®</span>')
                                .replace(/\(âš ï¸ ç›ˆäºæ¯”ä¸ä½³ï¼Œè°¨æ…å…¥åœº\)/g, '<span class="text-warning fw-bold">âš ï¸ ç›ˆäºæ¯”å·®</span>')
                                .replace(/\[OBVè¶‹åŠ¿ç¡®è®¤\]/g, '<span class="badge bg-warning text-dark">OBVè¶‹åŠ¿ç¡®è®¤</span>'); // é«˜äº®å†…å®¹é‡Œçš„ OBV

                            // ä¸´æ—¶ä¿®å¤ï¼šå¤„ç† UNKNOWN çš„é—®é¢˜
                            // å¦‚æœå¸ç§æ˜¯ UNKNOWNï¼Œå°è¯•ä»ç¬¬ä¸€è¡Œå†æ¬¡è§£æ
                            // ä¹‹å‰çš„é€»è¾‘æ˜¯åªçœ‹ matchï¼Œå¯èƒ½ alert.content ç¬¬ä¸€è¡Œæ ¼å¼ç•¥æœ‰ä¸åŒ
                            // æ¯”å¦‚æ—¥å¿—ä¸­æ˜¯: 2026-02-02 ... | WARNING | ... - ğŸš¨ ã€é«˜åˆ†æŠ¥è­¦ã€‘ ...
                            // æˆ‘ä»¬å·²ç» split æ‰äº†å‰ç¼€ï¼Œä½†å¯èƒ½ symbol è§£æçš„æ­£åˆ™å¤ªæ­»æ¿
                            // ç°åœ¨çš„æ—¥å¿—æ ¼å¼: "ğŸš¨ ã€é«˜åˆ†æŠ¥è­¦ã€‘ æˆ‘è¸é©¬æ¥äº†/USDT:USDT | Score: 80"
                            // æ­£åˆ™ /ã€é«˜åˆ†æŠ¥è­¦ã€‘\s+([A-Z0-9\/:]+)/ å¯ä»¥åŒ¹é… "æˆ‘è¸é©¬æ¥äº†/USDT:USDT" å—ï¼Ÿ
                            // [A-Z0-9\/:] ä¸åŒ…å«ä¸­æ–‡ã€‚
                            // ä¿®å¤æ­£åˆ™ä»¥æ”¯æŒä»»æ„å­—ç¬¦ä½œä¸ºå¸ç§åç§° (æˆ–è€…è‡³å°‘æ›´å®½æ³›)
                            if (symbol === "UNKNOWN") {
                                const retryMatch = alert.content.match(/ã€é«˜åˆ†æŠ¥è­¦ã€‘\s+(.+?)\s+\|/);
                                if (retryMatch) symbol = retryMatch[1];
                            }

                            html += `
                                <div class="card alert-card mb-3 ${stickyClass}" ${isObvTrend ? 'style="background-color: #fffbf0;"' : ''}>
                                    <div class="card-header d-flex justify-content-between align-items-center bg-white">
                                        <div>
                                            <span class="h5 mb-0 me-2">${symbol}</span>
                                            ${directionBadge}
                                            ${obvBadge}
                                            ${countBadge}
                                        </div>
                                        <div>
                                            <span class="badge bg-dark">Score: ${score}</span>
                                            <small class="text-muted ms-2">${alert.time}</small>
                                        </div>
                                    </div>
                                    <div class="card-body pt-2">
                                        <div class="mb-2"><strong>å½“å‰ä»·æ ¼:</strong> ${price}</div>
                                        <div class="card-text text-secondary" style="font-size: 0.95rem;">${formattedContent}</div>
                                    </div>
                                </div>
                            `;
                        });
                        alertsContainer.innerHTML = html;
                    } else {
                        alertCount.innerText = 0;
                        alertsContainer.innerHTML = '<div class="text-center text-muted p-5">æš‚æ— æŠ¥è­¦ä¿¡å·</div>';
                    }
                })
                .catch(err => console.error('Error fetching data:', err));
        }

        // é¦–æ¬¡åŠ è½½
        updateData();
        // æ¯ 3 ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(updateData, 3000);

        // æ¸…é™¤æŠ¥è­¦å‡½æ•°
        function clearAlerts() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²æŠ¥è­¦è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            fetch('/api/clear_alerts', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // ç«‹å³åˆ·æ–°æ•°æ®
                        updateData();
                    } else {
                        alert('æ¸…é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(err => console.error('Error clearing alerts:', err));
        }

        // å‘é€ Discord æµ‹è¯•æ¶ˆæ¯
        function testDiscord(btn) {
            const originalText = btn.innerText;
            btn.innerText = 'å‘é€ä¸­...';
            btn.disabled = true;

            fetch('/api/test_discord', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        alert('âœ… ' + data.message);
                    } else {
                        alert('âŒ ' + data.message);
                    }
                })
                .catch(err => {
                    console.error('Error testing discord:', err);
                    alert('âŒ è¯·æ±‚å‘é€å¤±è´¥');
                })
                .finally(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }
    </script>
</body>
</html>

const defaultSymbols=["btcusdt","ethusdt","solusdt"];let symbols=[...defaultSymbols];let ws=null;let domRows=new Map();let lastPrices=new Map();let selectedSymbol=null;const tbody=document.getElementById("symbols-body");const input=document.getElementById("symbol-input");const addBtn=document.getElementById("add-symbol");const chartTitle=document.getElementById("chart-title");const ctx=document.getElementById("price-chart").getContext("2d");const chart=new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label:"价格",data:[],borderColor:"#0ea5e9",backgroundColor:"rgba(14,165,233,0.2)",tension:0.2,pointRadius:0}]},options:{animation:false,responsive:true,scales:{x:{ticks:{display:false}},y:{beginAtZero:false}}}});function toLower(s){return s.trim().toLowerCase()}function format(n){return Number(n).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:8})}function renderRows(){tbody.innerHTML="";domRows.clear();symbols.forEach(s=>{const tr=document.createElement("tr");tr.dataset.symbol=s;const name=document.createElement("td");name.textContent=s.toUpperCase();const price=document.createElement("td");price.textContent="—";const change=document.createElement("td");change.textContent="—";const status=document.createElement("td");status.className="status";status.textContent="等待";tr.appendChild(name);tr.appendChild(price);tr.appendChild(change);tr.appendChild(status);tr.addEventListener("click",()=>selectSymbol(s));tbody.appendChild(tr);domRows.set(s,{price,change,status,tr})})}function selectSymbol(s){selectedSymbol=s;chart.data.labels.length=0;chart.data.datasets[0].data.length=0;chart.update();chartTitle.textContent=s.toUpperCase()+" 实时价格"}function connect(){if(ws)ws.close();const streams=symbols.map(x=>x+"@ticker").join("/");ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+streams);ws.onopen=()=>symbols.forEach(s=>{const row=domRows.get(s);if(row)row.status.textContent="连接"});ws.onmessage=ev=>{const msg=JSON.parse(ev.data);const d=msg.data;const s=toLower(d.s);const price=d.c;const pct=d.P;const row=domRows.get(s);if(!row)return;const prev=lastPrices.get(s);lastPrices.set(s,Number(price));row.price.textContent=format(price);row.change.textContent=(Number(pct)>=0?"+":"")+Number(pct).toFixed(2)+"%";row.change.className=Number(pct)>=0?"up":"down";if(prev!==undefined){row.status.textContent=Number(price)>=prev?"↑":"↓";row.status.className=Number(price)>=prev?"status up":"status down"}if(selectedSymbol===s){const t=Date.now();chart.data.labels.push(t);chart.data.datasets[0].data.push(Number(price));const max=300;if(chart.data.labels.length>max){chart.data.labels.shift();chart.data.datasets[0].data.shift()}chart.update()}};ws.onclose=()=>setTimeout(()=>connect(),1500);ws.onerror=()=>{}}addBtn.addEventListener("click",()=>{const raw=input.value;if(!raw)return;const s=toLower(raw);if(!/^[a-z0-9]{6,}$/.test(s))return;if(symbols.includes(s))return;symbols.push(s);renderRows();connect();input.value=""});renderRows();selectSymbol(symbols[0]);connect();


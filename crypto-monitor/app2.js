const defaultSymbols=["btcusdt","ethusdt","solusdt"];let symbols=[...defaultSymbols];let ws=null;let domRows=new Map();let lastPrices=new Map();let selectedSymbol=null;let priceHistory=new Map();let alerts=new Map();const tbody=document.getElementById("symbols-body");const input=document.getElementById("symbol-input");const addBtn=document.getElementById("add-symbol");const chartTitle=document.getElementById("chart-title");const forecastPrice=document.getElementById("forecast-price");const forecastDelta=document.getElementById("forecast-delta");const forecastConf=document.getElementById("forecast-conf");const alertPriceInput=document.getElementById("alert-price");const alertDirSelect=document.getElementById("alert-dir");const setAlertBtn=document.getElementById("set-alert");const alertStatus=document.getElementById("alert-status");const ctx=document.getElementById("price-chart").getContext("2d");const chart=new Chart(ctx,{type:"line",data:{datasets:[{label:"价格",data:[],borderColor:"#0ea5e9",backgroundColor:"rgba(14,165,233,0.2)",tension:0.2,pointRadius:0},{label:"预测",data:[],borderColor:"#f59e0b",backgroundColor:"rgba(245,158,11,0.08)",borderDash:[6,4],tension:0,pointRadius:0}]},options:{animation:false,responsive:true,parsing:false,scales:{x:{type:"linear",ticks:{display:false}},y:{beginAtZero:false}}}});function toLower(s){return s.trim().toLowerCase()}function format(n){return Number(n).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:8})}function renderRows(){tbody.innerHTML="";domRows.clear();symbols.forEach(s=>{const tr=document.createElement("tr");tr.dataset.symbol=s;const name=document.createElement("td");name.textContent=s.toUpperCase();const price=document.createElement("td");price.textContent="—";const change=document.createElement("td");change.textContent="—";const status=document.createElement("td");status.className="status";status.textContent="等待";tr.appendChild(name);tr.appendChild(price);tr.appendChild(change);tr.appendChild(status);tr.addEventListener("click",()=>selectSymbol(s));tbody.appendChild(tr);domRows.set(s,{price,change,status,tr})})}function selectSymbol(s){selectedSymbol=s;chart.data.datasets[0].data.length=0;chart.data.datasets[1].data.length=0;chart.update();chartTitle.textContent=s.toUpperCase()+" 实时价格";updateForecastUI(null);const a=alerts.get(s);if(a){alertStatus.textContent=(a.dir===">="?"已设置：达到 ≥ ":"已设置：达到 ≤ ")+format(a.price);alertStatus.className="alert-active"}else{alertStatus.textContent="未设置";alertStatus.className=""}}function connect(){if(ws)ws.close();const streams=symbols.map(x=>x+"@ticker").join("/");ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+streams);ws.onopen=()=>symbols.forEach(s=>{const row=domRows.get(s);if(row)row.status.textContent="连接"});ws.onmessage=ev=>{const msg=JSON.parse(ev.data);const d=msg.data;const s=toLower(d.s);const price=d.c;const pct=d.P;const t=Date.now();const row=domRows.get(s);if(!row)return;const prev=lastPrices.get(s);const p=Number(price);lastPrices.set(s,p);row.price.textContent=format(p);row.change.textContent=(Number(pct)>=0?"+":"")+Number(pct).toFixed(2)+"%";row.change.className=Number(pct)>=0?"up":"down";if(prev!==undefined){row.status.textContent=p>=prev?"↑":"↓";row.status.className=p>=prev?"status up":"status down"}let h=priceHistory.get(s);if(!h){h=[];priceHistory.set(s,h)}h.push({t,p});const cutoff=t-30*60*1000;while(h.length&&h[0].t<cutoff)h.shift();if(selectedSymbol===s){chart.data.datasets[0].data.push({x:t,y:p});const max=300;if(chart.data.datasets[0].data.length>max){chart.data.datasets[0].data.shift()}const f=forecast15m(h);if(f){chart.data.datasets[1].data=[{x:t,y:p},{x:t+15*60*1000,y:f.pred}]}else{chart.data.datasets[1].data=[]}chart.update();updateForecastUI(f);const a=alerts.get(s);if(a&&!a.fired){if((a.dir===">="&&p>=a.price)||(a.dir==="<="&&p<=a.price)){a.fired=true;alerts.set(s,a);alertStatus.textContent="已触发：当前价 "+format(p);alertStatus.className="alert-triggered";beep()}}}};ws.onclose=()=>setTimeout(()=>connect(),1500);ws.onerror=()=>{}}addBtn.addEventListener("click",()=>{const raw=input.value;if(!raw)return;const s=toLower(raw);if(!/^[a-z0-9]{6,}$/.test(s))return;if(symbols.includes(s))return;symbols.push(s);renderRows();connect();input.value=""});function updateForecastUI(f){if(!f){forecastPrice.textContent="—";forecastDelta.textContent="—";forecastDelta.className="";forecastConf.textContent="—";return}forecastPrice.textContent=format(f.pred);const delta=f.pred-(lastPrices.get(selectedSymbol)||f.pred);const isUp=delta>=0;forecastDelta.textContent=(isUp?"+":"")+format(delta);forecastDelta.className=isUp?"delta-up":"delta-down";forecastConf.textContent=f.conf}function forecast15m(h){if(!h||h.length<20)return null;const tLast=h[h.length-1].t;const windowMin=10*60*1000;const filtered=h.filter(x=>x.t>=tLast-windowMin);if(filtered.length<10)return null;let xs=[];let ys=[];for(let i=0;i<filtered.length;i++){xs.push((filtered[i].t-tLast)/60000);ys.push(filtered[i].p)}let xMean=0,yMean=0;for(let i=0;i<xs.length;i++){xMean+=xs[i];yMean+=ys[i]}xMean/=xs.length;yMean/=ys.length;let cov=0,varx=0;for(let i=0;i<xs.length;i++){const dx=xs[i]-xMean;const dy=ys[i]-yMean;cov+=dx*dy;varx+=dx*dx}if(varx===0)return null;const slope=cov/varx;const intercept=yMean-slope*xMean;const xFuture=15;const pred=intercept+slope*xFuture;let sse=0,sst=0;for(let i=0;i<xs.length;i++){const yHat=intercept+slope*xs[i];const dy=ys[i]-yHat;sse+=dy*dy;const dyy=ys[i]-yMean;sst+=dyy*dyy}let r2=sst===0?0:1-(sse/sst);if(r2<0)r2=0;if(r2>1)r2=1;let conf="低";if(r2>0.7)conf="高";else if(r2>0.4)conf="中";return{pred,conf}}function beep(){try{const ac=new (window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();const g=ac.createGain();o.type="sine";o.frequency.value=880;o.connect(g);g.connect(ac.destination);g.gain.setValueAtTime(0.001,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.2,ac.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.0001,ac.currentTime+0.4);o.start();o.stop(ac.currentTime+0.5)}catch(e){}}setAlertBtn.addEventListener("click",()=>{const v=parseFloat(alertPriceInput.value);if(!selectedSymbol||!isFinite(v))return;const dir=alertDirSelect.value;alerts.set(selectedSymbol,{price:v,dir,fired:false});alertStatus.textContent=(dir===">="?"已设置：达到 ≥ ":"已设置：达到 ≤ ")+format(v);alertStatus.className="alert-active"});renderRows();selectSymbol(symbols[0]);connect();

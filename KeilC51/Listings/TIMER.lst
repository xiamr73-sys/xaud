C51 COMPILER V9.52.0.0   TIMER                                                             12/02/2025 15:24:49 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN .\Output\TIMER.obj
COMPILER INVOKED BY: E:\tools\keil4\C51\BIN\C51.EXE ..\User\source\Hardware\TIMER.c LARGE OMF2 WARNINGLEVEL(0) BROWSE FL
                    -OATFUZZY(4) INCDIR(..\User\include;..\FU68xx_Haidware_Driver\Include) DEBUG PRINT(.\Listings\TIMER.lst) TABS(2) OBJECT(.
                    -\Output\TIMER.obj)

line level    source

   1          /*  --------------------------- (C) COPYRIGHT 2020 Fortiortech ShenZhen -----------------------------
   2              File Name      : TIMER.c
   3              Author         : Fortiortech  Appliction Team
   4              Version        : V1.0
   5              Date           : 2020-04-11
   6              Description    : This file contains .C file function used for Motor Control.
   7              ----------------------------------------------------------------------------------------------------
   8                                                 All Rights Reserved
   9              ------------------------------------------------------------------------------------------------- */
  10          #include "Myproject.h"
  11          
  12          /*---------------------------------------------------------------------------*/
  13          /*  Name     :   void Timer1_Init(void)
  14              /* Input    :   NO
  15              /* Output   :   NO
  16              /* Description: Timer1的参数设置
  17              /*---------------------------------------------------------------------------*/
  18          /* TIM1捕获中断定时器 */
  19          void TIM1_HALL_Init(void)
  20          {
  21   1          /* 禁用定时器 */
  22   1          ClrBit(TIM1_CR0, T1BCEN);
  23   1      
  24   1          /* 定时器分频 */
  25   1          SetReg(TIM1_CR3, T1PSC2 | T1PSC1 | T1PSC0, T1PSC2 |T1PSC1| T1PSC0);
  26   1        
  27   1          /* 基本定时器计数值及重载值 */
  28   1          TIM1__BARR  = 60000;
  29   1          TIM1__BCNTR = 0;
  30   1      
  31   1          //CMP_CR4  FAEN 使能后，TIM1_CR3 的 T1INM 和 CMP_SAMR 的参数均扩大 4 倍
  32   1          SetBit(CMP_CR4, FAEN);
  33   1          
  34   1          /* HALL输入滤波 */
  35   1          SetReg(TIM1_CR3, T1INM1 | T1INM0, T1INM1 | T1INM0);  // 96x41.67ns = 4us滤波时长。
  36   1        
  37   1          /* 输入源选择 */
  38   1          ClrBit(TIM1_CR3, T1TIS1 | T1TIS0);
  39   1          ClrBit(CMP_CR1, HALLSEL);
  40   1        
  41   1          /* 触发极性 */
  42   1          SetBit(TIM1_DBR7, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  43   1      //    SetBit(TIM1_DBR6, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  44   1      //    SetBit(TIM1_DBR5, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  45   1      //    SetBit(TIM1_DBR4, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  46   1      //    SetBit(TIM1_DBR3, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  47   1      //    SetBit(TIM1_DBR2, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  48   1      //    SetBit(TIM1_DBR1, T1CPE2 | T1CPE1 | T1CPE0); // 三相双跳变沿
  49   1          
  50   1          TIM1_CR4 = 7;
  51   1            
  52   1          /* 设置事件复位源 */
  53   1          SetBit(TIM1_CR2, T1BRS);  // 位置检测复位
C51 COMPILER V9.52.0.0   TIMER                                                             12/02/2025 15:24:49 PAGE 2   

  54   1          
  55   1          /* 开启位置检测中断 */
  56   1          SetBit(TIM1_IER, T1PDIE);  
  57   1      
  58   1          PTIM11 = 1;
  59   1          PTIM10 = 1;
  60   1          /*  开定时器上溢中断 */
  61   1          ClrBit(TIM1_IER, T1BOIE);
  62   1          
  63   1          /* 使能定时器 */
  64   1          SetBit(TIM1_CR0, T1BCEN);
  65   1        
  66   1          /* 清除中断标志位 - 初始化 */
  67   1          ClrBit(TIM1_SR, T1BOIF | T1ROIF | T1WTIF | T1PDIF | T1BDIF);
  68   1          
  69   1      
  70   1      }
  71          /*---------------------------------------------------------------------------*/
  72          /*  Name     :   void Timer2_Init(void)
  73              /* Input    :   NO
  74              /* Output   :   NO
  75              /* Description: Timer2的参数设置
  76              /*---------------------------------------------------------------------------*/
  77          void Timer2_Init(void)
  78          {
  79   1          SetBit(PH_SEL, T2SEL);           //P10
  80   1          SetBit(PH_SEL, T2SSEL);          //P07
  81   1          ClrBit(TIM2_CR0, T2PSC2);        //计数器时钟分频选择
  82   1          ClrBit(TIM2_CR0, T2PSC1);        //000-->24M        001-->12M       010-->6M    011-->3M
  83   1          ClrBit(TIM2_CR0, T2PSC0);        //100-->1.5M   101-->750K      110-->375K  111-->187.5K
  84   1          ClrBit(TIM2_CR0, T2OCM);
  85   1          SetBit(TIM2_CR0, T2IRE);         //比较匹配中断/脉宽检测中断0-->Disable  1-->Enable
  86   1          ClrBit(TIM2_CR0, T2CES);
  87   1          ClrBit(TIM2_CR1, T2IPE);         //输入Timer PWM周期检测中断使能 0-->Disable  1-->Enable
  88   1          ClrBit(TIM2_CR1, T2IFE);         //计数器上溢中断使能 0-->Disable  1-->Enable
  89   1          ClrBit(TIM2_CR1, T2FE);          //输入噪声滤波使能，小于4个时钟周期脉宽滤除
  90   1          ClrBit(TIM2_CR1, T2DIR);         //QEP&ISD&步进模式专用：当前的方向 0-->正向  1-->反向
  91   1          TIM2__DR = 1200;
  92   1          TIM2__ARR = 2400;
  93   1          ClrBit(TIM2_CR0, T2MOD1);        //00-->输入Timer模式           01-->输出模式
  94   1          SetBit(TIM2_CR0, T2MOD0);        //10-->输入Counter模式         11-->QEP&ISD&步进模式
  95   1          SetBit(TIM2_CR1, T2CEN);         //TIM2使能   0-->Disable  1-->Enable
  96   1      }
  97          
  98          void Timer2_QEP_Init(void)
  99          {
 100   1        SetBit(PH_SEL , T2SEL);     //P10
 101   1        SetBit(PH_SEL , T2SSEL);    //P07 
 102   1        
 103   1      ////  ClrBit(TIM2_CR0 , T2PSC2);  //计数器时钟分频选择  //001
 104   1      ////  ClrBit(TIM2_CR0 , T2PSC1);  //000-->24M   001-->12M   010-->6M  011-->3M
 105   1      ////  SetBit(TIM2_CR0 , T2PSC0);  //100-->1.5M  101-->750K    110-->375K  111-->187.5K
 106   1        
 107   1          ClrBit(TIM2_CR0 , T2PSC2);  //计数器时钟分频选择  //001
 108   1        SetBit(TIM2_CR0 , T2PSC1);  //000-->24M   001-->12M   010-->6M  011-->3M
 109   1        SetBit(TIM2_CR0 , T2PSC0);  //100-->1.5M  101-->750K    110-->375K  111-->187.5K
 110   1        
 111   1        ClrBit(TIM2_CR0 , T2OCM);
 112   1        
 113   1        ClrBit(TIM2_CR0 , T2IRE); // QEP模式方向改变中断使能
 114   1        ClrBit(TIM2_CR0 , T2CES); // QEP模式 外部中断1(零点)清零脉冲计数器使能
 115   1        
C51 COMPILER V9.52.0.0   TIMER                                                             12/02/2025 15:24:49 PAGE 3   

 116   1        #if (Speed_Method ==  T_Method) 
              
                ClrBit(TIM2_CR1 , T2IPE); //输入有效边沿变化使能 0-->Disable  1-->Enable
                SetBit(TIM2_CR1 , T2IFE); //计数器上溢中断使能 0-->Disable  1-->Enable
                
                #endif
 122   1        
 123   1        SetBit(TIM2_CR1 , T2FE);  //输入噪声滤波使能，小于4个时钟周期脉宽滤除 4*41.67ns = 166.
             -67ns
 124   1        ClrBit(TIM2_CR1 , T2DIR); //QEP&ISD&步进模式专用：当前的方向 0-->正向 1-->反向  
 125   1        
 126   1        
 127   1      #if (Speed_Method ==  T_Method) 
                
                PTIM21 = 1;
                PTIM20 = 0;// TIM2/2中断优先级别为2
              
              #endif
 133   1      //  TIM2__DR = 1200;
 134   1      //  TIM2__ARR = 2400;
 135   1        
 136   1          SetBit(TIM2_CR0 , T2MOD1);  //00-->输入Timer模式        01-->输出模式
 137   1         SetBit(TIM2_CR0 , T2MOD0); //10-->输入Counter模式      11-->QEP&ISD&步进模式
 138   1        
 139   1          SetBit(TIM2_CR1 , T2CEN); //TIM2使能  0-->Disable  1-->Enable
 140   1          
 141   1      }
 142          /*---------------------------------------------------------------------------*/
 143          /*  Name     :   void Timer3_Init(void)
 144              /* Input    :   NO
 145              /* Output   :   NO
 146              /* Description: Timer3的参数设置
 147              /*---------------------------------------------------------------------------*/
 148          void Timer3_Init(void)
 149          {
 150   1          SetBit(PH_SEL, T3SEL);            //Timer3端口使能
 151   1          ClrBit(PH_SEL1, T3CT);            //默认端口为P11,功能转移后为P01,需TIMER4转移到P00
 152   1          SetBit(TIM3_CR0, T3PSC2);         //计数器时钟分频选择
 153   1          ClrBit(TIM3_CR0, T3PSC1);         //000-->24M       001-->12M       010-->6M    011-->3M
 154   1          SetBit(TIM3_CR0, T3PSC0);         //100-->1.5M  101-->750K      110-->375K  111-->187.5K
 155   1          ClrBit(TIM3_CR0, T3OCM);
 156   1          ClrBit(TIM3_CR0, T3IRE);          //比较匹配中断/脉宽检测中断0-->Disable  1-->Enable
 157   1          ClrBit(TIM3_CR0, T3OPM);          //0-->计数器不停止      1-->单次模式
 158   1          SetBit(TIM3_CR1, T3IPE);          //输入Timer PWM周期检测中断使能 0-->Disable  1-->Enable
 159   1          SetBit(TIM3_CR1, T3IFE);          //计数器上溢中断使能 0-->Disable  1-->Enable
 160   1          ClrBit(TIM3_CR1, T3NM1);          //输入噪声脉宽选择
 161   1          ClrBit(TIM3_CR1, T3NM0);          //00-->不滤波  01-->4cycles    10-->8cycles  11-->16cycles
 162   1          //  TIM3__DR = 1200;
 163   1          //  TIM3__ARR = 65535;
 164   1          ClrBit(TIM3_CR0, T3MOD);           //0-->Timer模式       1-->输出模式
 165   1          SetBit(TIM3_CR1, T3EN);            //TIM3使能    0-->Disable  1-->Enable
 166   1      }
 167          /*---------------------------------------------------------------------------*/
 168          /*  Name     :   void Timer4_Init(void)
 169              /* Input    :   NO
 170              /* Output   :   NO
 171              /* Description: Timer4的参数设置
 172              /*---------------------------------------------------------------------------*/
 173          void Timer4_Init(void)
 174          {
 175   1          SetBit(PH_SEL, T4SEL);               //Timer4端口使能
 176   1          SetBit(PH_SEL1, T4CT);               //默认端口为P01,功能转移后为P00
C51 COMPILER V9.52.0.0   TIMER                                                             12/02/2025 15:24:49 PAGE 4   

 177   1          //  ClrBit(TIM4_CR0 , T4PSC2);       //计数器时钟分频选择
 178   1          //  ClrBit(TIM4_CR0 , T4PSC1);       //000-->24M        001-->12M       010-->6M    011-->3M
 179   1          //  ClrBit(TIM4_CR0 , T4PSC0);       //100-->1.5M   101-->750K      110-->375K  111-->187.5K
 180   1          SetReg(TIM4_CR0, T3PSC2 | T3PSC1 | T3PSC0, T3PSC2);
 181   1          SetBit(TIM4_CR0, T4OCM);
 182   1          ClrBit(TIM4_CR0, T4IRE);             //比较匹配中断/脉宽检测中断0-->Disable  1-->Enable
 183   1          ClrBit(TIM4_CR0, T4OPM);             //0-->计数器不停止       1-->单次模式
 184   1          ClrBit(TIM4_CR1, T4IPE);             //输入Timer PWM周期检测中断使能 0-->Disable  1-->Enable
 185   1          ClrBit(TIM4_CR1, T4IFE);             //计数器上溢中断使能 0-->Disable  1-->Enable
 186   1          ClrBit(TIM4_CR1, T4NM1);             //输入噪声脉宽选择
 187   1          ClrBit(TIM4_CR1, T4NM0);             //00-->不滤波   01-->4cycles  10-->8cycles  11-->16cycles
 188   1          TIM4__ARR = 65535;
 189   1          SetBit(TIM4_CR0, T4MOD);             //0-->Timer模式  1-->输出模式
 190   1          SetBit(TIM4_CR1, T4EN);              //TIM4使能   0-->Disable  1-->Enable
 191   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    328    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
